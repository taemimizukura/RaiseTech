# Lecture05
## EC2 上にサンプルアプリケーションをデプロイして、動作確認  
※第3回で使用したサンプルアプリケーションを使用　　
- まずは組み込みサーバーだけで動作確認
ruby 3.1.2
Bundler 2.3.14
Rails 7.0.4
Node 17.9.1
yarn 1.22.19

- サーバーアプリケーションを分けて動作確認

## ELB(ALB)を追加して動作確認

## さらにS3を追加して動作確認
(S3 と連携している EC2 上からファイルを削除したり、追加した際にちゃんとS3 のバケットに反映されているかどうか。逆に S3 側で削除したり追加したものが EC2 に反映されているかどうか。)


## 環境の構成図

### EC2にアプリケーションのデプロイ
- S3はVPCの外にある
- EC2インスタンスは１つでも可
- EC2へサンプルアプリケーションに必要な環境をセット
アップする。  
※必ず「インストールしたモジュール」と「行った作業」は記録しておく
- Ruby の Capistranoのようなデプロイツールは不要
- EC2状にDBを構築するのはNG。事前に作成したRDSへ繋ぐ
- ポート番号に気を付ける(必要なポート番号だけを開けて接続確認)
- Elastic IPを使ってEC2のIPを固定化するのはやめたほうがいいかも
- まずは組み込みサーバーのみで正しく動作する環境を作りましょう
- 上記が問題なくできたら、Webサーバー(Nginx)、APサーバー(Unicorn)と個別にサーバーを立てる
- Railsは組み込み型なのでアプリを配置して起動コマンドをたたけば動きくが、実際の現場では組み込みサーバーは使わないことが多い
- いきなりサーバーを分けた構成は作らない
### ELB経由でEC2へ接続（冗長化・負荷分散）
- デプロイができて、外部からの接続による実行確認も取れたら、 ELB(Elastic Load Balancing)による冗長化構成を構築します。
- ELB は、通信の情報と振分先を設定するだけで、自動的に冗長化構成を組んでくれるサービスです。種類が複数あり、とくにALB、NLBは現場でもよく使います。
- CLB は基本的には使わない
- 【ALB】Webアプリケーションは基本的にはALBを選ぶ。HTTPやHTTPSの負荷分散に特化している
- 【NLB】受け取ったプロトコルをそのままバランシングする
HTTP通信の中身をチェックしないといけない、URLに応じた振り分けという機能はない.
NLBは固定IPアドレスを持つため、IPアドレスでアクセスしたいケース、IPアドレス変動が困るケースではNLB一択になる。

### アプリケーションのデータ保存先を S3 に変更
- S3=ストレージ　Webアプリケーションを公開して運用する場合ほぼ利用
ただし、ログファイルや画像ファイル等、静的なものに限る。
- S3は、key(場所)とvalue(その場所に格納されたデータ)という形でデータを保存
- たとえば「/var/www/html/index.html」というパス(Path)のファイルを扱う場合、S3 では
key = /var/www/html/index.html
value = index.html の中身となる
- S3をEC2から直接使うにはいくつかの設定が必要。AWS CLIを使ったり、AWS SDK
を使って自作のプログラムから読み書きさせたり、S3を直接マウントするための仕組みを使用したり、さまざまです。
※ちなみに、S3 を直接マウントする方式はデータの破損が起こりやすく、AWS
もMountpoint for Amazon S3を使った特定のケース以外認めていません。新規プロジェクトで S3 をマウントする検討が上がった場合は、その旨を伝えて、他の案を検討してもらいましょう。課題の構成ではとくに影響はありませんので、直接マウントでも OK です。
画像ファイル(静的)等をおいて動作確認してみる
ここらへんの設定をしておくと冗長化構成で EC2 が 2 台構成になっても、同じ S3 バケットを見に行けば良いので、同じ画像ファイルを置いたりする必要がなくなります。
- S3 はストレージとしての役割だけでなく、静的 Web サイトとしても利用されたりします。



